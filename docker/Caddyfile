{
	admin off
}

(remdo_tinyauth) {
	forward_auth 127.0.0.1:{env.TINYAUTH_PORT} {
		uri /api/auth/caddy
		copy_headers Remote-User Remote-Name Remote-Email Remote-Groups
		header_down Location "{env.TINYAUTH_APP_URL}" "{http.request.scheme}://{http.request.hostport}"
	}
}

:{$PORT} {
	handle_path /health {
		respond 200
	}

	@app_favicon path /favicon.ico /favicon.svg
	handle @app_favicon {
		root * /srv/remdo
		rewrite * /favicon.svg
		file_server
	}

	@tinyauth_paths {
		path \
 /login /login/* \
 /authorize /authorize/* \
 /logout /logout/* \
 /continue /continue/* \
 /totp /totp/* \
 /forgot-password /forgot-password/* \
 /unauthorized /unauthorized/* \
 /error /error/* \
 /resources/* \
 /api/user/* \
 /api/oauth/* \
 /api/context/* \
 /api/healthz \
 /api/auth/* \
 /assets/* \
 /background.jpg \
 /favicon-96x96.png \
 /apple-touch-icon.png \
 /site.webmanifest \
 /web-app-manifest-192x192.png \
 /web-app-manifest-512x512.png
	}
	handle @tinyauth_paths {
		reverse_proxy 127.0.0.1:{env.TINYAUTH_PORT}
	}

	@options method OPTIONS
	handle @options {
		respond 204
	}

	handle /doc* {
		import remdo_tinyauth
		reverse_proxy 127.0.0.1:{env.COLLAB_SERVER_PORT}
	}

	handle /d/* {
		import remdo_tinyauth
		reverse_proxy 127.0.0.1:{env.COLLAB_SERVER_PORT}
	}

	handle {
		route {
			import remdo_tinyauth
			root * /srv/remdo
			try_files {path} {path}/ /index.html
			file_server
		}
	}
}
